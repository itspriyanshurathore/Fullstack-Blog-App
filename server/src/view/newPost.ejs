<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create New Blog Post</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      #imagePreview {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 5px;
        display: none;
      }

      .preview-card {
        display: none;
        transition: all 0.3s ease;
      }

      .preview-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.15);
      }

      #dropZone {
        cursor: pointer;
        transition: 0.3s;
        border-style: dashed !important;
      }

      #dropZone.hover {
        border-color: #0d6efd !important;
        background-color: #e9f2ff;
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.4);
      }
    </style>
  </head>

  <body class="bg-light">
    <%- include('partials/header') %>

    <div class="container mt-5">
      <h2 class="fw-bold text-primary text-center mb-4">
        <i class="bi bi-plus-circle"></i> Create New Blog Post
      </h2>

      <div class="row g-4">
        <!-- LEFT FORM -->
        <div class="col-md-6">
          <div class="card p-4 shadow-sm">
            <form
              action="/post/create"
              method="POST"
              enctype="multipart/form-data"
              class="d-grid gap-3"
            >
              <!-- DRAG & DROP -->
              <div class="mb-3">
                <label class="fw-semibold">Upload Image</label>

                <div
                  id="dropZone"
                  class="border border-2 border-primary rounded-3 p-5 text-center bg-white"
                >
                  <i class="bi bi-cloud-arrow-up display-3 text-primary"></i>
                  <p class="mt-2 mb-0 fw-semibold">Drag & Drop your image</p>
                  <p class="text-muted small">or click to browse</p>

                  <input
                    type="file"
                    name="image"
                    id="imageInput"
                    accept="image/*"
                    hidden
                    required
                  />
                </div>
              </div>

              <!-- AI BUTTON -->
              <button
                type="button"
                id="aiGenerateBtn"
                class="btn btn-outline-secondary w-100"
              >
                <i class="bi bi-magic"></i> Generate with AI
              </button>

              <!-- TITLE -->
              <div>
                <label class="fw-semibold">Blog Title</label>
                <input
                  type="text"
                  name="title"
                  id="titleInput"
                  class="form-control"
                  placeholder="Enter blog title"
                  required
                />
              </div>

              <!-- DESCRIPTION -->
              <div>
                <label class="fw-semibold">Short Description</label>
                <input
                  type="text"
                  name="description"
                  id="descInput"
                  class="form-control"
                  placeholder="Write a short description"
                  required
                />
              </div>

              <!-- CATEGORY -->
              <div>
                <label class="fw-semibold">Category</label>
                <input
                  type="text"
                  name="category"
                  id="categoryInput"
                  class="form-control"
                  placeholder="e.g. Travel, Technology, Food"
                  required
                />
              </div>

              <!-- CONTENT -->
              <div>
                <label class="fw-semibold">Full Content</label>
                <textarea
                  name="content"
                  id="contentInput"
                  rows="5"
                  class="form-control"
                  placeholder="Write your blog content here..."
                  required
                ></textarea>
              </div>

              <!-- SUBMIT -->
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-upload"></i> Publish Blog
              </button>
            </form>
          </div>
        </div>

        <!-- RIGHT PREVIEW -->
        <div class="col-md-6">
          <div class="card shadow-sm p-3 preview-card" id="previewCard">
            <img id="imagePreview" alt="Preview Image" />

            <h3 class="mt-3" id="previewTitle"></h3>

            <span id="previewCategory" class="badge mb-2 bg-secondary"></span>

            <p class="text-muted" id="previewDesc"></p>
            <p id="previewContent"></p>
          </div>
        </div>
      </div>
    </div>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SCRIPT -->
    <script>
      const imageInput = document.getElementById("imageInput");
      const imagePreview = document.getElementById("imagePreview");
      const previewCard = document.getElementById("previewCard");

      const previewTitle = document.getElementById("previewTitle");
      const previewDesc = document.getElementById("previewDesc");
      const previewCategory = document.getElementById("previewCategory");
      const previewContent = document.getElementById("previewContent");
      const dropZone = document.getElementById("dropZone");

      /* ---------------------------------------
         ICON MAP
      ---------------------------------------- */
      const categoryIcons = {
        travel: "bi bi-airplane-fill",
        adventure: "bi bi-compass-fill",
        tourism: "bi bi-geo-alt-fill",

        technology: "bi bi-cpu-fill",
        tech: "bi bi-laptop-fill",
        ai: "bi bi-robot",
        coding: "bi bi-code-slash",
        programming: "bi bi-terminal-fill",
        software: "bi bi-gear-fill",

        food: "bi bi-egg-fried",
        cooking: "bi bi-fire",
        recipes: "bi bi-journal-text",
        restaurant: "bi bi-shop",

        lifestyle: "bi bi-brightness-high-fill",
        fashion: "bi bi-handbag-fill",
        beauty: "bi bi-star-fill",

        fitness: "bi bi-heart-pulse-fill",
        health: "bi bi-heart-fill",
        workout: "bi bi-lightning-fill",
        yoga: "bi bi-peace-fill",

        business: "bi bi-briefcase-fill",
        marketing: "bi bi-bar-chart-fill",
        startup: "bi bi-graph-up-arrow",
        finance: "bi bi-cash-coin",
        investment: "bi bi-bank2",

        education: "bi bi-book-fill",
        study: "bi bi-backpack-fill",
        learning: "bi bi-lightbulb-fill",

        photography: "bi bi-camera-fill",
        nature: "bi bi-tree-fill",
        wildlife: "bi bi-flower3",

        sports: "bi bi-trophy-fill",
        gaming: "bi bi-controller",

        music: "bi bi-music-note-beamed",
        movies: "bi bi-film",
        entertainment: "bi bi-emoji-smile-fill",

        general: "bi bi-tag-fill",
        other: "bi bi-dash-circle-fill",
      };

      /* ---------------------------------------
         COLOR MAP
      ---------------------------------------- */
      const categoryColors = {
        travel: "bg-primary",
        adventure: "bg-info text-dark",
        tourism: "bg-primary",

        technology: "bg-success",
        tech: "bg-success",
        ai: "bg-dark",
        coding: "bg-secondary",
        programming: "bg-secondary",
        software: "bg-dark",

        food: "bg-warning text-dark",
        cooking: "bg-warning text-dark",

        lifestyle: "bg-info text-dark",
        fashion: "bg-pink text-white",
        beauty: "bg-purple text-white",

        fitness: "bg-danger",
        workout: "bg-danger",
        yoga: "bg-success",

        business: "bg-dark",
        marketing: "bg-dark",
        finance: "bg-warning text-dark",
        investment: "bg-dark",

        education: "bg-secondary",
        study: "bg-secondary",

        photography: "bg-light text-dark border",
        nature: "bg-success",
        wildlife: "bg-success text-dark",

        sports: "bg-danger",
        gaming: "bg-dark",

        music: "bg-dark",
        movies: "bg-primary",

        general: "bg-secondary",
      };

      /* ---------------------------------------
         DRAG & DROP
      ---------------------------------------- */
      dropZone.addEventListener("click", () => imageInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("hover");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("hover")
      );
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("hover");

        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          imageInput.files = e.dataTransfer.files;
          imagePreview.src = URL.createObjectURL(file);
          imagePreview.style.display = "block";
          previewCard.style.display = "block";
        }
      });

      imageInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          imagePreview.src = URL.createObjectURL(file);
          imagePreview.style.display = "block";
          previewCard.style.display = "block";
        }
      });

      /* ---------------------------------------
         LIVE PREVIEW
      ---------------------------------------- */
      document.getElementById("titleInput").addEventListener("input", (e) => {
        previewTitle.textContent = e.target.value;
        previewCard.style.display = "block";
      });

      document.getElementById("descInput").addEventListener("input", (e) => {
        previewDesc.textContent = e.target.value;
      });

      document
        .getElementById("categoryInput")
        .addEventListener("input", (e) => {
          const inputVal = e.target.value.trim() || "General";
          const catKey = inputVal.toLowerCase();

          // ICON
          const icon = categoryIcons[catKey] || "bi bi-tag-fill";

          // COLOR
          const color = categoryColors[catKey] || "bg-secondary";

          previewCategory.className = `badge mb-2 ${color}`;
          previewCategory.innerHTML = `<i class="${icon}"></i> ${inputVal}`;
        });

      document.getElementById("contentInput").addEventListener("input", (e) => {
        previewContent.textContent = e.target.value;
      });

      /* ---------------------------------------
         AI GENERATE
      ---------------------------------------- */
      document
        .getElementById("aiGenerateBtn")
        .addEventListener("click", async () => {
          if (!imageInput.files[0]) {
            alert("Please upload an image first!");
            return;
          }

          const formData = new FormData();
          formData.append("image", imageInput.files[0]);

          const aiBtn = document.getElementById("aiGenerateBtn");
          aiBtn.innerHTML =
            "<i class='bi bi-hourglass-split'></i> Generating...";
          aiBtn.disabled = true;

          try {
            const response = await fetch("/ai/generate", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            // Fill form
            document.getElementById("titleInput").value = data.title || "";
            document.getElementById("descInput").value = data.description || "";
            document.getElementById("categoryInput").value =
              data.category || "General";
            document.getElementById("contentInput").value = data.content || "";

            // Update preview
            previewTitle.textContent = data.title || "";
            previewDesc.textContent = data.description || "";

            const catKey = (data.category || "general").toLowerCase().trim();

            const icon = categoryIcons[catKey] || "bi bi-tag-fill";
            const color = categoryColors[catKey] || "bg-secondary";

            previewCategory.className = `badge mb-2 ${color}`;
            previewCategory.innerHTML = `<i class="${icon}"></i> ${data.category}`;

            previewContent.textContent = data.content || "";
            previewCard.style.display = "block";

            aiBtn.innerHTML = "<i class='bi bi-magic'></i> Generated!";
          } catch (err) {
            console.error(err);
            alert("AI generation failed.");
            aiBtn.innerHTML = "<i class='bi bi-magic'></i> Generate with AI";
          }

          aiBtn.disabled = false;
        });
    </script>
  </body>
</html>
