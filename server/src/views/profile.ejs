<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Profile</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
      }

      .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.1);
        transition: 0.25s ease;
      }

      .input-group-text {
        background: #f1f1f1;
        border-right: none;
      }

      .form-control {
        border-left: none !important;
      }

      .profile-card {
        max-width: 780px;
        margin: auto;
      }
    </style>
  </head>

  <body>
    <%- include("partials/header") %>

    <div class="container py-5">
      <!-- CENTERED USER PROFILE CARD -->
      <div class="card shadow-sm p-5 mb-5 profile-card text-center">
        <!-- AVATAR + INFO -->
        <div class="d-flex flex-column align-items-center">
          <img
            src="<%= user.profilePicture?.url || '/default-avatar.png'%>"
            class="profile-avatar"
            alt="Profile"
          />

          <h2 class="fw-bold mt-3"><%= user.username %></h2>

          <p class="text-muted"><%= user.bio || "No bio added yet." %></p>

          <p class="text-muted m-0">
            <i class="bi bi-telephone"></i> <%= user.tel || "No phone added" %>
          </p>

          <div class="mt-3">
            <span class="badge bg-primary fs-6 px-3 py-2">
              <i class="bi bi-file-text"></i> Total Posts: <%= postCount %>
            </span>
          </div>
        </div>

        <hr class="my-4" />

        <!-- EDIT ACCOUNT BUTTON -->
        <button
          class="btn btn-outline-primary mb-3"
          onclick="document.getElementById('editForm').classList.toggle('d-none')"
        >
          <i class="bi bi-gear"></i> Edit Account
        </button>

        <!-- EDIT FORM - HIDDEN INITIALLY -->
        <div id="editForm" class="d-none text-start mt-4">
          <h4 class="fw-bold mb-3 text-center">
            <i class="bi bi-pencil-square"></i> Update Profile
          </h4>

          <form
            action="/profile/update"
            method="POST"
            enctype="multipart/form-data"
          >
            <div class="row">
              <!-- Username -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Username</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-person"></i
                  ></span>
                  <input
                    type="text"
                    name="username"
                    class="form-control"
                    value="<%= user.username %>"
                    required
                  />
                </div>
              </div>

              <!-- Phone -->
              <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Phone Number</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-telephone-inbound"></i
                  ></span>
                  <input
                    type="number"
                    name="tel"
                    class="form-control"
                    value="<%= user.tel || '' %>"
                  />
                </div>
              </div>

              <!-- Bio -->
              <div class="col-12 mb-3">
                <label class="form-label fw-semibold">Bio</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-chat-dots"></i
                  ></span>
                  <textarea name="bio" class="form-control" rows="3">
<%= user.bio || '' %></textarea
                  >
                </div>
              </div>

              <!-- Avatar -->
              <div class="col-12 mb-3">
                <label class="form-label fw-semibold">Change Avatar</label>
                <div class="input-group">
                  <span class="input-group-text"
                    ><i class="bi bi-image"></i
                  ></span>
                  <input type="file" name="avatar" class="form-control" />
                </div>
              </div>

              <div class="col-12 mb-2 text-center">
                <button class="btn btn-primary px-4">
                  <i class="bi bi-check-circle"></i> Save Changes
                </button>
              </div>
            </div>
          </form>
        </div>

        <hr class="my-4" />

        <!-- DELETE ACCOUNT -->
        <form
          action="/profile/delete"
          method="POST"
          class="text-center"
          onsubmit="return confirm('Delete your entire account? This cannot be undone.')"
        >
          <button class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Account
          </button>
        </form>
      </div>

      <!-- USER POSTS SECTION -->
      <h3 class="fw-bold mb-3 text-center">
        <i class="bi bi-journal"></i> Your Blog Posts
      </h3>

      <% if (posts.length === 0) { %>
      <div class="alert alert-info text-center">No posts created yet.</div>
      <% } %>

      <div class="row g-4">
        <% posts.forEach(post => { %>
        <div class="col-md-4">
          <div class="card post-card shadow-sm">
            <img
              src="<%= post.images?.[0]?.url || 'https://via.placeholder.com/400x250?text=No+Image' %>"
              class="card-img-top"
              style="height: 180px; object-fit: cover"
              alt="Blog image"
            />

            <div class="card-body">
              <h5 class="card-title"><%= post.title.substring(0, 25) %></h5>
              <p class="text-muted">
                <%= post.description.substring(0, 60) %>...
              </p>

              <div class="d-flex justify-content-between mt-3">
                <a
                  href="/post/edit/<%= post._id %>"
                  class="btn btn-sm btn-warning"
                >
                  <i class="bi bi-pencil-square"></i>
                </a>

                <form method="POST" action="/post/delete/<%= post._id %>">
                  <button
                    class="btn btn-sm btn-danger"
                    onclick="return confirm('Delete this post?')"
                  >
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <%- include("partials/footer") %>
  </body>
</html>
